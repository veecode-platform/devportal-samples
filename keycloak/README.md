# Keycloak Example

This example shows how to configure Keycloak as an authentication provider for DevPortal.

## How to use

After setting up the pre-requisites, just run:

```bash
docker compose up --no-log-prefix
```

And open <http://localhost:7007> in your browser.

## Pre-requisites

1. Keycloak server running with a configured realm

    We are using a free tier Keycloak realm from [Phase2](https://app.phasetwo.io/).

    - Create a realm with a unique name (e.g. `veecode`)
    - Create an OIDC client
      - Client type: OpenID Connect
      - Client ID: `veecode`
      - Client authentication: on
      - Authorization: on
      - Authentication flows: Standard flow, Direct access grants
      - **Service accounts roles: on** (required for org sync)
      - Root URL: `http://localhost:7007`
      - Home URL: `http://localhost:7007`
      - Valid Redirect URIs: `http://localhost:7007/*`
      - Web Origins: `*`
    - OIDC `veecode` Credentials:
      - Client authenticator: Client Id and Secret
      - Client secret: (generated by Keycloak, take note of it)
    - **Service Account Roles** (required for user/group sync):
      - Go to Clients → `veecode` → Service Account Roles
      - Click "Assign role" → Filter by clients → Select `realm-management`
      - Assign: `view-users`, `query-users`, `query-groups`

2. Keycloak users and groups created

    - Create these groups in your realm:
      - `backstage-admins`
      - `backstage-users`
    - Create a few users in your realm
      - Add them to the groups above as you see fit

3. Criar arquivo .env com as variáveis de ambiente

   - KEYCLOAK_BASE_URL
   - KEYCLOAK_REALM
   - KEYCLOAK_METADATA_URL (opcional)
   - KEYCLOAK_CLIENT_ID
   - KEYCLOAK_CLIENT_SECRET

   A variável `KEYCLOAK_METADATA_URL` é opcional (será calculada como `${KEYCLOAK_BASE_URL}/realms/${KEYCLOAK_REALM}` se não for informada).

   Versões menos recentes do Keycloak terão o path `/auth` ao final de `${KEYCLOAK_BASE_URL}`.

4. Testar a URL de discovery da realm:

   - Acessar <https://usw2.auth.ac/auth/realms/KEYCLOAK_REALM/.well-known/openid-configuration>

5. Testar a autenticação com `curl`:

    ```bash
    curl -X POST -H "Content-Type: application/x-www-form-urlencoded" -d "grant_type=client_credentials&client_id=veecode&client_secret=CLIENT_SECRET" https://usw2.auth.ac/auth/realms/veecode/protocol/openid-connect/token
    ```

## Tips

You can filter the logs to see the Org sync process:

```bash
docker compose up --no-log-prefix | grep KeycloakOrg
```

Output would contain something like:

```pre
2026-02-05T00:24:19.742Z catalog info Committed 3 Keycloak users and 2 Keycloak groups in 0.0 seconds. class="KeycloakOrgEntityProvider" taskId="KeycloakOrgEntityProvider:default:refresh" taskInstanceId="7e532234-0b67-4476-99a0-a57be07d4461"
```
